/**
 * Created by mao on 17-1-26.
 */
var CLIENT_ID="399696677123-4en316frmevqe3elac4ddl95qfdvtgfs.apps.googleusercontent.com";var SCOPES=["https://www.googleapis.com/auth/calendar"];var network_unavailable=setInterval("Materialize.toast('要翻墙哦', 5000)",8000);var mSchedule=[];var classStartTimeWJ=["","08:00:00","08:55:00","10:00:00","10:55:00","14:00:00","14:55:00","15:50:00","16:55:00","17:50:00","19:30:00","20:25:00","21:20:00"];var classEndTimeWJ=["","08:45:00","09:40:00","10:45:00","11:40:00","14:45:00","15:40:00","16:35:00","17:40:00","18:35:00","20:15:00","21:10:00","22:05:00"];var classStartTimeJA=["","08:15:00","09:10:00","10:15:00","11:10:00","13:50:00","14:45:00","15:40:00","16:45:00","17:40:00","19:20:00","20:15:00","21:10:00"];var classEndTimeJA=["","09:00:00","09:55:00","11:00:00","11:55:00","14:35:00","15:30:00","16:25:00","17:30:00","18:25:00","20:05:00","21:00:00","21:55:00"];var events=[];var isInit=true;var tempName;function checkAuth(){gapi.auth.authorize({"client_id":CLIENT_ID,"scope":SCOPES.join(" "),"immediate":true},handleAuthResult)}function handleAuthResult(a){window.clearInterval(network_unavailable);$("#progress_bar").css("display","none");if(a&&!a.error){$("#authorize-div").css("display","none");$("#jwc_auth_form").css("display","inline");Materialize.toast("Google账户登录成功",3000)}else{$("#authorize-div").css("display","inline");if(!isInit){Materialize.toast("Google账户登录失败",3000)}}}function handleGoogleAuthClick(a){isInit=false;$("#progress_bar").css("display","inline");gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:false},handleAuthResult);return false}function loadCalendarApi(){gapi.client.load("calendar","v3",startSync);return false}function haha(){if(events.length==0){Materialize.toast("导入完成",3000);$("#progress_bar").css("display","none");$("#authorize-div").css("display","inline");return false}var b=events.shift();tempName=b["summary"];var a=gapi.client.calendar.events.insert({"calendarId":"primary","resource":b});a.execute(function(c){Materialize.toast("导入"+tempName+"成功");haha();$("#progress_hint").text("正在导入"+tempName)})}function startSync(){$("#show_schedule_div").css("display","none");$("#progress_bar").css("display","inline");var f=$(".filled-in");for(var j in f){if(f[j].checked){for(var d in mSchedule[j]["time"]){if(mSchedule[j]["time"][d]["start"]==null){continue}var h=mSchedule[j]["time"][d]["start"];var e=mSchedule[j]["time"][d]["end"];var b=mSchedule[j]["time"][d]["week"];var c=new Date();c.setFullYear(2017,1,26);var k=new Date();k.setFullYear(c.getFullYear(),c.getMonth(),c.getDate());if(!(mSchedule[j]["even"]||mSchedule[j]["odd"])){k.setDate(k.getDate()+b-7+7*mSchedule[j]["weekStart"])}else{if(mSchedule[j]["even"]){k.setDate(k.getDate()+b+7)}else{k.setDate(k.getDate()+b)}}var g=mSchedule[j]["weekEnd"]-mSchedule[j]["weekStart"]+1;if(mSchedule[j]["even"]||mSchedule[j]["odd"]){g=18/2}var i=k.getFullYear()+"-"+(k.getMonth()+1)+"-"+k.getDate();var a={"summary":mSchedule[j]["title"],"location":mSchedule[j]["time"][d]["address"],"description":(mSchedule[j]["description"]+" by SCUScheduler"),"start":{"dateTime":(i+"T"+((mSchedule[j]["time"][d]["address"].indexOf("江安")>=0)?classStartTimeJA[h]:classStartTimeWJ[h])),"timeZone":"Asia/Shanghai"},"end":{"dateTime":(i+"T"+((mSchedule[j]["time"][d]["address"].indexOf("江安")>=0)?classEndTimeJA[e]:classEndTimeWJ[e])),"timeZone":"Asia/Shanghai"},"recurrence":[("RRULE:FREQ=WEEKLY;COUNT="+g+((mSchedule[j]["even"]||mSchedule[j]["odd"])?";INTERVAL=2":""))],"colorId":(j%11+1).toString(),"attendees":[],"reminders":{"useDefault":false,"overrides":[{"method":"popup","minutes":30}]}};events.push(a)}}}haha();$("#progress_hint").text("正在导入"+tempName)}function showSchedule(b,a){var c='<li><div class="collapsible-header "><div class="row"><br><div class="col s11"><input type="checkbox" class="filled-in center-align" id="check-'+a+'" checked="checked"/><label for="check-'+a+'" class="black-text center-align">'+b["title"]+'</label></div><div class="col white-text">.</div></div></div><div class="collapsible-body"><br><div class="row"><div class="col s12"><div class="col"><i class="material-icons">class</i></div><div class="col">';if(!(b["even"]||b["odd"])){c+=b["weekStart"]+"~"+b["weekEnd"]}if(b["even"]){c+="双"}if(b["odd"]){c+="单"}c+="周</div></div></div>";b["time"].forEach(function(e,d){c+='<div class="row"><div class="col s6"><div class="col"><i class="material-icons">date_range</i></div><div class="col">'+"周"+e["week"]+"第"+e["start"]+"～"+e["end"]+"节"+'</div></div><div class="col s6"><div class="col"><i class="material-icons">place</i></div><div class="col">'+e["address"]+"</div></div></div>"});c+='<div class="row"><div class="col s12"><div class="col"><i class="material-icons">assignment</i></div><div class="col">'+b["description"]+"</div></div></div></div></li>";$("#schedule_list").append(c)}function getSchedule(form){$("#jwc_auth_form").css("display","none");$("#progress_bar").css("display","inline");$("#progress_hint").text("正在爬取课表");$.get("http://weixin.i-teacher.net/schedule/index.jsp?zjh="+$("#zjh").val()+"&mm="+$("#mm").val(),function(data,status){$("#progress_bar").css("display","none");if(data.indexOf("不正确")>=0){Materialize.toast("帐号或密码错误，请重新输入",5000);$("#jwc_auth_form").css("display","inline")}else{Materialize.toast("爬取课表成功",5000);mSchedule=eval(data);mSchedule.forEach(showSchedule);$("#show_schedule_div").css("display","inline");Materialize.showStaggeredList("#schedule_list")}});return false};